parameters:
  - name: artifactName
    type: string
    default: ""
  - name: downloadPath
    type: string
    default: ''
  - name: downloadRunId
    type: string
    default: ''

# Why use az cli to download? → The ARM agent may run into OutOfMemory issues.  
# Why install Python? → Azure CLI requires Python to run.  
# Why install Azure CLI? → It is not pre-installed on the agent.  
# Why not use AzureCLI@2 task? → It requires azureSubscription, which is unnecessary for downloading artifacts.
steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.11'
      addToPath: true
      architecture: 'x86'

  # Update pip to latest
  - pwsh: python -m pip install --upgrade pip
    displayName: 'Upgrade pip'

  # Update to latest Azure CLI version
  - pwsh: pip install --pre azure-cli
    displayName: 'Upgrade Azure CLI'

  - pwsh: az --version
    displayName: 'Show Azure CLI version'

  - pwsh: az devops configure --defaults organization='$(System.TeamFoundationCollectionUri)' project='$(System.TeamProject)' --use-git-aliases true
    displayName: 'Set default Azure DevOps organization and project'

  - pwsh: az pipelines runs artifact download --artifact-name ${{parameters.artifactName}} --path "${{parameters.downloadPath}}" --run-id ${{parameters.downloadRunId}} --debug
    displayName: 'Download artifacts with Azure CLI'
    env:
      AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
